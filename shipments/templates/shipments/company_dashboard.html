{% extends 'shipments/base.html' %}

{% block title %}Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø±ÙƒØ© - Ø§Ù„Ø´Ø­Ù†Ø§Øª{% endblock %}

{% block extra_css %}
<style>
    /* ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù‡Ø°Ù‡ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù…Ù„Ù base.html Ø§Ù„Ø¢Ù† */
    .map-container {
        height: 300px;
        border-radius: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
    }
    #mapPicker {
        height: 500px; 
    }
    .modal-content {
        border-radius: 15px;
    }
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø­Ù†Ø© */
    .status-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: bold;
        color: #fff;
    }
    .status-pending { background-color: #ffc107; color: #343a40; }
    .status-picked_up { background-color: #0d6efd; }
    .status-in_transit { background-color: #6c757d; }
    .status-out_for_delivery { background-color: #fd7e14; }
    .status-delivered { background-color: #28a745; }
    .status-cancelled { background-color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-12">
        <div class="card mb-5 bg-white">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="text-dark fw-bold mb-0"><i class="fas fa-tachometer-alt text-primary me-2"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createShipmentModal">
                        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø´Ø­Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h4 class="card-title mb-4 fw-bold text-dark"><i class="fas fa-list me-2 text-info"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø­Ù†Ø§Øª</h4>
                
                <div id="shipmentsContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                        </div>
                        <p class="mt-2 text-muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø­Ù†Ø§Øª...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# --- Modal: Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø­Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø© --- #}
<div class="modal fade" id="createShipmentModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i> Ø¥Ø¶Ø§ÙØ© Ø´Ø­Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modalError" class="alert alert-danger d-none"></div>
                <div id="modalSuccess" class="alert alert-success d-none"></div>
                
                <form id="createShipmentForm">
                    <div class="row">
                        <div class="col-md-6 border-end">
                            <h6 class="text-primary mb-3"><i class="fas fa-box-open me-1"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø­Ù†Ø© ÙˆØ§Ù„Ù…Ø±Ø³Ù„</h6>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„</label>
                                <input type="text" class="form-control" id="senderName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±Ø³Ù„</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="senderAddress" required>
                                    <button type="button" class="btn btn-outline-primary" onclick="openMapPicker('sender')">
                                        <i class="fas fa-map-marker-alt"></i> Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø±Ø³Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</label>
                                <div id="senderMap" class="map-container"></div>
                                <input type="hidden" id="senderLat">
                                <input type="hidden" id="senderLng">
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h6 class="text-success mb-3"><i class="fas fa-user-check me-1"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…</h6>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
                                <input type="text" class="form-control" id="receiverName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="receiverAddress" required>
                                    <button type="button" class="btn btn-outline-success" onclick="openMapPicker('receiver')">
                                        <i class="fas fa-map-marker-alt"></i> Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø³ØªÙ„Ù…</label>
                                <input type="email" class="form-control" id="receiverEmail" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªÙ„Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</label>
                                <div id="receiverMap" class="map-container"></div>
                                <input type="hidden" id="receiverLat">
                                <input type="hidden" id="receiverLng">
                            </div>
                        </div>
                    </div>

                    <hr>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</label>
                            <input type="number" step="0.01" class="form-control" id="weight" required onchange="calculatePrice()">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)</label>
                            <input type="number" step="0.01" class="form-control" id="distance" readonly placeholder="ÙŠØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø¬Ù†ÙŠÙ‡)</label>
                            <input type="number" step="0.01" class="form-control bg-light" id="price" readonly>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" onclick="submitShipment()">
                    <i class="fas fa-check"></i> Ø­ÙØ¸ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ø­Ù†Ø©
                </button>
            </div>
        </div>
    </div>
</div>

{# --- Modal: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ø­Ù†Ø©) --- #}
<div class="modal fade" id="mapPickerModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="mapPickerTitle"><i class="fas fa-map-marked-alt me-2"></i> Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info py-2">
                    <i class="fas fa-info-circle me-1"></i> **Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©** Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø«.
                </div>
                
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="mapSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù† (Ù…Ø«Ø§Ù„: Ù…ÙŠØ¯Ø§Ù† Ø§Ù„ØªØ­Ø±ÙŠØ±)">
                        <button class="btn btn-info text-white" type="button" onclick="searchLocation()">
                            <i class="fas fa-search"></i> Ø¨Ø­Ø«
                        </button>
                    </div>
                </div>
                
                <div id="mapPicker"></div>
                
                <div id="selectedLocationInfo" class="alert alert-success mt-3" style="display: none;">
                    <p class="mb-1">**Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:** <span id="selectedAddress">-</span></p>
                    <p class="mb-0">**Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:** <span id="selectedCoords">-</span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" onclick="confirmLocation()" disabled id="confirmLocationBtn">
                    <i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                </button>
            </div>
        </div>
    </div>
</div>

{# --- Modal: ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø­Ù†Ø© --- #}
<div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-history me-2"></i> ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø­Ù†Ø©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="statusModalError" class="alert alert-danger d-none"></div>
                <input type="hidden" id="updateShipmentId">
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                    <select class="form-select" id="newStatus" required>
                        <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                        <option value="picked_up">ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</option>
                        <option value="in_transit">ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚</option>
                        <option value="out_for_delivery">Ø®Ø§Ø±Ø¬ Ù„Ù„ØªÙˆØµÙŠÙ„</option>
                        <option value="delivered">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
                        <option value="cancelled">Ù…Ù„ØºÙŠ</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù†Øµ)</label>
                    <input type="text" class="form-control" id="currentLocation" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø±ÙƒØ² Ø§Ù„ØªÙˆØ²ÙŠØ¹ - Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©">
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©</label>
                    <div id="statusMap" class="map-container"></div>
                    <input type="hidden" id="statusLat">
                    <input type="hidden" id="statusLng">
                    <small class="text-muted">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø´Ø­Ù†Ø©</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea class="form-control" id="statusNotes" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-warning text-dark" onclick="submitStatusUpdate()">
                    <i class="fas fa-check"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let senderMap, receiverMap, statusMap, mapPickerMap;
let senderMarker, receiverMarker, statusMarker, pickerMarker;
let currentPickerType = null;
let selectedLocation = null;

const DEFAULT_CENTER = [30.0444, 31.2357]; // Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©
const DEFAULT_ZOOM = 10;

// =======================================================
// ğŸ—ºï¸ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© 
// =======================================================

function initLeafletMap(mapId, initialLat, initialLng, clickHandler) {
    let mapInstance;
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„ØªØ¬Ù†Ø¨ ØªØ±Ø§ÙƒØ¨ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØªØ­
    const mapElement = document.getElementById(mapId);
    if (mapElement && mapElement._leaflet_id !== undefined) {
        try { 
            // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£ÙˆÙ„Ø§ Ù‚Ø¨Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥Ø²Ø§Ù„Ø©
            if(L.DomUtil.get(mapId)._leaflet_id) {
                L.map(mapId).remove();
            }
        } catch(e) { /* ignore */ }
    }

    try {
        mapInstance = L.map(mapId).setView([initialLat, initialLng], DEFAULT_ZOOM);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(mapInstance);
        
        if (clickHandler) {
            mapInstance.on('click', clickHandler);
        }

        // Ø§Ù„Ø­Ù„ Ù„Ø¸Ù‡ÙˆØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙÙŠ Ø§Ù„Ù€ Modal: Invalidating Size
        setTimeout(() => {
            mapInstance.invalidateSize();
        }, 100);

        return mapInstance;
    } catch (error) {
        console.error(`Error initializing map ${mapId}:`, error);
        return null;
    }
}

function initSenderMap() {
    // Ø§Ø³ØªØ®Ø¯Ù… initLeafletMap Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† L.map Ù…Ø¨Ø§Ø´Ø±Ø©
    senderMap = initLeafletMap('senderMap', DEFAULT_CENTER[0], DEFAULT_CENTER[1]);
}

function initReceiverMap() {
    receiverMap = initLeafletMap('receiverMap', DEFAULT_CENTER[0], DEFAULT_CENTER[1]);
}

function initStatusMap(lat = DEFAULT_CENTER[0], lng = DEFAULT_CENTER[1]) {
    // ØªÙ‡ÙŠØ¦Ø© Ø®Ø±ÙŠØ·Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
    statusMap = initLeafletMap('statusMap', lat, lng, async function(e) {
        const { lat, lng } = e.latlng;
        updateStatusMarker(lat, lng);
    });
}

function updateMapMarker(map, markerRefName, color, lat, lng, addressId, latId, lngId, title) {
    let currentMarker;
    if (markerRefName === 'senderMarker') currentMarker = senderMarker;
    else if (markerRefName === 'receiverMarker') currentMarker = receiverMarker;

    if (currentMarker) {
        map.removeLayer(currentMarker);
    }
    
    const customIcon = L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    const newMarker = L.marker([lat, lng], { icon: customIcon }).addTo(map);

    // Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ù„Ù… ÙŠØ¹Ø¯ Ø¶Ø±ÙˆØ±ÙŠØ§Ù‹ Ù‡Ù†Ø§ØŒ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ø§Ù„Ù€ Picker Modal
    // const address = await getAddressFromCoordinates(lat, lng); 
    const address = document.getElementById(addressId).value;

    if (address) {
        newMarker.bindPopup(`<b>${title}</b><br>${address}`).openPopup();
    } else {
        newMarker.bindPopup(`<b>${title}</b>`).openPopup();
    }

    document.getElementById(latId).value = lat.toFixed(6);
    document.getElementById(lngId).value = lng.toFixed(6);
    
    if (markerRefName === 'senderMarker') senderMarker = newMarker;
    else if (markerRefName === 'receiverMarker') receiverMarker = newMarker;
}

function updateStatusMarker(lat, lng) {
    if (statusMarker) {
        statusMap.removeLayer(statusMarker);
    }
    
    const icon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    statusMarker = L.marker([lat, lng], { icon: icon }).addTo(statusMap);
    statusMarker.bindPopup('<b>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</b>').openPopup();
    
    document.getElementById('statusLat').value = lat.toFixed(6);
    document.getElementById('statusLng').value = lng.toFixed(6);
}


// =======================================================
// ğŸ“Œ Map Picker Functions
// =======================================================

function openMapPicker(type) {
    currentPickerType = type;
    selectedLocation = null;
    
    const title = type === 'sender' ? 'Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø±Ø³Ù„' : 'Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…';
    document.getElementById('mapPickerTitle').textContent = title;
    document.getElementById('selectedLocationInfo').style.display = 'none';
    document.getElementById('confirmLocationBtn').disabled = true;
    
    const modalElement = document.getElementById('mapPickerModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    modalElement.addEventListener('shown.bs.modal', function () {
        setTimeout(() => {
            initMapPicker();
        }, 100);
    }, { once: true });
}

function initMapPicker() {
    let initialLat = DEFAULT_CENTER[0];
    let initialLng = DEFAULT_CENTER[1];
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ±Ø§ÙƒØ¨
    if (mapPickerMap) {
        mapPickerMap.remove();
        mapPickerMap = null;
    }

    mapPickerMap = L.map('mapPicker').setView([initialLat, initialLng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(mapPickerMap);
    
    mapPickerMap.on('click', async function(e) {
        await handleMapClick(e.latlng.lat, e.latlng.lng);
    });

    setTimeout(() => mapPickerMap.invalidateSize(), 100);
}

async function handleMapClick(lat, lng) {
    if (pickerMarker) {
        mapPickerMap.removeLayer(pickerMarker);
    }
    
    const iconColor = currentPickerType === 'sender' ? 'blue' : 'green';
    const customIcon = L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${iconColor}.png`,
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    pickerMarker = L.marker([lat, lng], { icon: customIcon }).addTo(mapPickerMap);
    
    const address = await getAddressFromCoordinates(lat, lng);
    
    selectedLocation = {
        lat: lat,
        lng: lng,
        address: address || 'Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
    };
    
    document.getElementById('selectedAddress').textContent = selectedLocation.address;
    document.getElementById('selectedCoords').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    document.getElementById('selectedLocationInfo').style.display = 'block';
    document.getElementById('confirmLocationBtn').disabled = false;
    
    pickerMarker.bindPopup(`<b>${selectedLocation.address}</b>`).openPopup();
}

function confirmLocation() {
    if (!selectedLocation) return;
    
    const lat = selectedLocation.lat;
    const lng = selectedLocation.lng;
    const address = selectedLocation.address;

    if (currentPickerType === 'sender') {
        document.getElementById('senderAddress').value = address;
        document.getElementById('senderLat').value = lat.toFixed(6);
        document.getElementById('senderLng').value = lng.toFixed(6);
        // ÙŠØ¬Ø¨ Ø£Ù† Ù†Ø¶Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØµØºÙŠØ±Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡Ø§ Ø¨Ø¹Ø¯
        if (!senderMap) initSenderMap();
        updateMapMarker(senderMap, 'senderMarker', 'blue', lat, lng, 'senderAddress', 'senderLat', 'senderLng', 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø±Ø³Ù„');
    } else {
        document.getElementById('receiverAddress').value = address;
        document.getElementById('receiverLat').value = lat.toFixed(6);
        document.getElementById('receiverLng').value = lng.toFixed(6);
        // ÙŠØ¬Ø¨ Ø£Ù† Ù†Ø¶Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØµØºÙŠØ±Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡Ø§ Ø¨Ø¹Ø¯
        if (!receiverMap) initReceiverMap();
        updateMapMarker(receiverMap, 'receiverMarker', 'green', lat, lng, 'receiverAddress', 'receiverLat', 'receiverLng', 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…');
    }
    
    calculateDistanceAndPrice();
    bootstrap.Modal.getInstance(document.getElementById('mapPickerModal')).hide();
}

async function searchLocation() {
    const query = document.getElementById('mapSearch').value.trim();
    if (!query) return;
    
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&accept-language=ar`
        );
        const data = await response.json();
        
        if (data && data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lng = parseFloat(data[0].lon);
            
            mapPickerMap.setView([lat, lng], 15);
            await handleMapClick(lat, lng);
        } else {
            alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù†.');
        }
    } catch (error) {
        console.error('Search error:', error);
    }
}

// =======================================================
// ğŸ“Š Calculations (Distance & Price)
// =======================================================

async function getAddressFromCoordinates(lat, lng) {
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=ar`
        );
        const data = await response.json();
        return data.display_name || 'Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
    } catch (error) {
        return null;
    }
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // km
    const dLat = (lat2 - lat1) * (Math.PI / 180);
    const dLon = (lon2 - lon1) * (Math.PI / 180);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return (R * c); 
}

function calculatePrice() {
    const basePrice = 50; 
    const weightRate = 10; 
    const distanceRate = 2; 
    
    const weight = parseFloat(document.getElementById('weight').value) || 0;
    const distance = parseFloat(document.getElementById('distance').value) || 0;
    
    const price = basePrice + (weight * weightRate) + (distance * distanceRate);
    
    document.getElementById('price').value = price.toFixed(2);
    return price;
}

function calculateDistanceAndPrice() {
    const senderLat = parseFloat(document.getElementById('senderLat').value);
    const senderLng = parseFloat(document.getElementById('senderLng').value);
    const receiverLat = parseFloat(document.getElementById('receiverLat').value);
    const receiverLng = parseFloat(document.getElementById('receiverLng').value);

    if (senderLat && senderLng && receiverLat && receiverLng) {
        const distance = calculateDistance(senderLat, senderLng, receiverLat, receiverLng);
        document.getElementById('distance').value = distance.toFixed(2);
        calculatePrice();
    } else {
        document.getElementById('distance').value = '0.00';
        calculatePrice();
    }
}

// =======================================================
// ğŸšš Shipment API/Data Functions
// =======================================================

function getStatusText(status) {
    const statusMap = {
        'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
        'picked_up': 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…',
        'in_transit': 'ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚',
        'out_for_delivery': 'Ø®Ø§Ø±Ø¬ Ù„Ù„ØªÙˆØµÙŠÙ„',
        'delivered': 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…',
        'cancelled': 'Ù…Ù„ØºÙŠ'
    };
    return statusMap[status] || status;
}

function displayShipments(shipments) {
    const container = document.getElementById('shipmentsContainer');
    
    if (shipments.length === 0) {
        container.innerHTML = '<div class="alert alert-info text-center"><i class="fas fa-info-circle me-1"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø­Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover align-middle">';
    html += '<thead class="table-light"><tr><th>Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹</th><th>Ø§Ù„Ù…Ø±Ø³Ù„</th><th>Ø§Ù„Ù…Ø³ØªÙ„Ù…</th><th>Ø§Ù„ÙˆØ²Ù†/Ø§Ù„Ù…Ø³Ø§ÙØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>';
    
    shipments.forEach(shipment => {
        html += `<tr>
            <td><strong>#${shipment.tracking_number}</strong></td>
            <td>${shipment.sender_name} <br><small class="text-muted">${shipment.sender_address.substring(0, 30)}...</small></td>
            <td>${shipment.receiver_name} <br><small class="text-muted">${shipment.receiver_address.substring(0, 30)}...</small></td>
            <td>${shipment.weight} ÙƒØ¬Ù… / ${shipment.distance_km || 'N/A'} ÙƒÙ…</td>
            <td><span class="status-badge status-${shipment.status}">${getStatusText(shipment.status)}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="openUpdateStatus(${shipment.id})">
                    <i class="fas fa-edit"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
                </button>
            </td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

async function loadShipments() {
    try {
        const response = await axios.get('/api/shipments/'); 
        displayShipments(response.data);
    } catch (error) {
        console.error('Error loading shipments:', error);
        document.getElementById('shipmentsContainer').innerHTML = 
            '<div class="alert alert-danger text-center"><i class="fas fa-times-circle me-1"></i> Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø­Ù†Ø§Øª. (ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ API)</div>';
    }
}

async function submitShipment() {
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    const data = {
        sender_name: document.getElementById('senderName').value,
        sender_address: document.getElementById('senderAddress').value,
        sender_lat: document.getElementById('senderLat').value || null,
        sender_lng: document.getElementById('senderLng').value || null,
        receiver_name: document.getElementById('receiverName').value,
        receiver_address: document.getElementById('receiverAddress').value,
        receiver_email: document.getElementById('receiverEmail').value,
        receiver_lat: document.getElementById('receiverLat').value || null,
        receiver_lng: document.getElementById('receiverLng').value || null,
        weight: parseFloat(document.getElementById('weight').value) || 0,
        distance_km: document.getElementById('distance').value ? parseFloat(document.getElementById('distance').value) : null
    };

    // ØªØ­Ù‚Ù‚ Ø£Ø³Ø§Ø³ÙŠ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!data.sender_name || !data.receiver_name || !data.receiver_email || data.weight === 0) {
        document.getElementById('modalError').textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ Ø§Ù„ÙˆØ²Ù†).';
        document.getElementById('modalError').classList.remove('d-none');
        document.getElementById('modalSuccess').classList.add('d-none');
        return;
    }

    try {
        const response = await axios.post('/api/shipments/create/', data);
        
        document.getElementById('modalSuccess').textContent = 
            `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ø­Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­! Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹: ${response.data.tracking_number}`;
        document.getElementById('modalSuccess').classList.remove('d-none');
        document.getElementById('modalError').classList.add('d-none');
        document.getElementById('createShipmentForm').reset();
        
        // Ù…Ø³Ø­ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø§Ø±ÙƒØ±Ø² Ù…Ù† Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„ØµØºÙŠØ±Ø©
        document.getElementById('senderLat').value = '';
        document.getElementById('senderLng').value = '';
        document.getElementById('receiverLat').value = '';
        document.getElementById('receiverLng').value = '';
        if (senderMarker) { senderMap.removeLayer(senderMarker); senderMarker = null; }
        if (receiverMarker) { receiverMap.removeLayer(receiverMarker); receiverMarker = null; }
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ Modal Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
        setTimeout(() => {
            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('createShipmentModal'));
            if (modalInstance) modalInstance.hide();
            document.getElementById('modalSuccess').classList.add('d-none');
            loadShipments();
        }, 3000);

    } catch (error) {
        console.error('Error:', error.response?.data);
        let errorMsg = JSON.stringify(error.response?.data || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ø­Ù†Ø©', null, 2);
        document.getElementById('modalError').innerHTML = `Ø­Ø¯Ø« Ø®Ø·Ø£: <pre>${errorMsg}</pre>`;
        document.getElementById('modalError').classList.remove('d-none');
        document.getElementById('modalSuccess').classList.add('d-none');
    }
}

async function openUpdateStatus(shipmentId) {
    document.getElementById('updateShipmentId').value = shipmentId;
    document.getElementById('statusModalError').classList.add('d-none');
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„ÙØªØ­
    document.getElementById('currentLocation').value = '';
    document.getElementById('statusLat').value = '';
    document.getElementById('statusLng').value = '';
    document.getElementById('statusNotes').value = '';
    
    const modalElement = document.getElementById('updateStatusModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();

    modalElement.addEventListener('shown.bs.modal', async function () {
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø¹ Ù…Ø±ÙƒØ² Ø§ÙØªØ±Ø§Ø¶ÙŠØŒ Ø«Ù… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø­Ù†Ø©
        initStatusMap(); 

        try {
            // Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø­Ù†Ø© (ÙŠØªØ·Ù„Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³Ø§Ø± /api/shipments/ID/ Ù…ÙØ¹Ø±Ù‘ÙØ§Ù‹ ÙÙŠ urls.py)
            const response = await axios.get(`/api/shipments/${shipmentId}/`);
            const shipment = response.data;

            document.getElementById('newStatus').value = shipment.status;

            let initialLat = DEFAULT_CENTER[0];
            let initialLng = DEFAULT_CENTER[1];

            if (statusMarker) { statusMap.removeLayer(statusMarker); statusMarker = null; }

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…ÙˆÙ‚Ø¹ Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡
            if (shipment.current_lat && shipment.current_lng) {
                initialLat = parseFloat(shipment.current_lat);
                initialLng = parseFloat(shipment.current_lng);
                document.getElementById('currentLocation').value = shipment.current_location_text || '';
                updateStatusMarker(initialLat, initialLng); 
            } else if (shipment.sender_lat && shipment.sender_lng) {
                // ÙˆØ¥Ù„Ø§ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø±Ø³Ù„ ÙƒÙ†Ù‚Ø·Ø© Ø¨Ø¯Ø§ÙŠØ© Ù„Ù„Ø®Ø±ÙŠØ·Ø©
                initialLat = parseFloat(shipment.sender_lat);
                initialLng = parseFloat(shipment.sender_lng);
            }

            // ØªØ­Ø¯ÙŠØ« Ù…Ø±ÙƒØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ­Ø¬Ù…Ù‡Ø§
            statusMap.setView([initialLat, initialLng], 12);
            statusMap.invalidateSize();

        } catch (error) {
            // Ù‡Ø°Ø§ Ù‡Ùˆ Ù…ÙƒØ§Ù† Ø¸Ù‡ÙˆØ± Ø±Ø³Ø§Ù„Ø© "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø­Ù†Ø©."
            document.getElementById('statusModalError').textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø­Ù†Ø©.';
            document.getElementById('statusModalError').classList.remove('d-none');
        }
    }, { once: true });
}

async function submitStatusUpdate() {
    const shipmentId = document.getElementById('updateShipmentId').value;
    const newStatus = document.getElementById('newStatus').value;
    const currentLocation = document.getElementById('currentLocation').value;
    const statusLat = document.getElementById('statusLat').value;
    const statusLng = document.getElementById('statusLng').value;
    const statusNotes = document.getElementById('statusNotes').value; // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª

    if (!newStatus) return;

    const data = {
        // ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªÙŠ ÙŠØªÙˆÙ‚Ø¹Ù‡Ø§ Ø§Ù„Ù€ Backend ÙÙŠ views.py
        status: newStatus,
        location: currentLocation,
        latitude: statusLat || null,
        longitude: statusLng || null,
        notes: statusNotes || null // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
    };
    
    // ** ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù€ Django Ù…ÙˆØ¬ÙˆØ¯Ø© **
    if (!data.location) {
        document.getElementById('statusModalError').textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù†Øµ).';
        document.getElementById('statusModalError').classList.remove('d-none');
        return;
    }


    try {
        // ğŸ”¥ğŸ”¥ğŸ”¥ ØªÙ… ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ø³Ø§Ø± Ù„ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ urls.py
        const response = await axios.post(`/api/shipments/${shipmentId}/update-status/`, data); 

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ Modal ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('updateStatusModal'));
        if (modalInstance) modalInstance.hide();
        loadShipments(); 
        
    } catch (error) {
        console.error('Error updating status:', error.response?.data);
        let errorMsg = error.response?.data?.error || JSON.stringify(error.response?.data || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.', null, 2);
        
        document.getElementById('statusModalError').innerHTML = `Ø­Ø¯Ø« Ø®Ø·Ø£: ${errorMsg}`;
        document.getElementById('statusModalError').classList.remove('d-none');
    }
}

// =======================================================
// ğŸš€ Initial Load
// =======================================================
document.addEventListener('DOMContentLoaded', () => {
    loadShipments();
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„ØµØºÙŠØ±Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù€ Modal Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
    const createShipmentModalElement = document.getElementById('createShipmentModal');
    createShipmentModalElement.addEventListener('shown.bs.modal', function () {
        initSenderMap();
        initReceiverMap();
    }, { once: true });
});

</script>
{% endblock %}